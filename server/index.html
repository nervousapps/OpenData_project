<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Simple markers</title>
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"
      integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ=="
      crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"
      integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log=="
      crossorigin=""></script>
    <script src="MovingMarker.js"></script>
  </head>
  <body>
    <div id='map'></div>
    <script>
      var mymap = L.map('map').setView([48.1103, -1.68039], 13);

      var xmlhttp = new XMLHttpRequest();
      var url = "https://data.rennesmetropole.fr/api/records/1.0/search/?dataset=parcours-des-lignes-de-bus-du-reseau-star&facet=nomcourtligne&facet=senscommercial&facet=nomarretdepart&facet=nomarretarrivee&facet=estaccessiblepmr&refine.nomcourtligne=C4";
      var stops;
      var lastcoordinate = [];
      var coordinate = [];

      L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
        maxZoom: 18,
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
          '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
          'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
        id: 'mapbox.streets'
      }).addTo(mymap);

      /**for(var i=0; i<stops.records.length; i++){
        L.marker([stops.records[i].geometry.coordinates[1], stops.records[i].geometry.coordinates[0]]).addTo(mymap)
          .bindPopup(stops.records[i].fields.nom).openPopup();
        linecoordinate.push([stops.records[i].geometry.coordinates[1], stops.records[i].geometry.coordinates[0]]);
      }*/

      var popup = L.popup();

      function onMapClick(e) {
        popup
          .setLatLng(e.latlng)
          .setContent("You clicked the map at " + e.latlng.toString())
          .openOn(mymap);
      }

      mymap.on('click', onMapClick);

      var myMovingMarker;

      var startMarker = function(){
        myMovingMarker = L.Marker.movingMarker(coordinate, [20000]).addTo(mymap);
        myMovingMarker.start();
      }

      var getCoordinate = function(){
        xmlhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                stops = JSON.parse(this.responseText);
            }
        }
        xmlhttp.open("GET", url, false);
        xmlhttp.send();

        coordinate.push(stops.records[0].fields.geo_point_2d);
        coordinate.push(stops.records[1].fields.geo_point_2d);
        L.marker(stops.records[0].fields.geo_point_2d).addTo(mymap)
          .bindPopup(stops.records[0].fields.nomarretdepart).openPopup();
        L.marker(stops.records[1].fields.geo_point_2d).addTo(mymap)
          .bindPopup(stops.records[1].fields.nomarretdepart).openPopup();
        //setInterval(startMarker, 5*1000);
        startMarker();

        for(var i=2; i<stops.records.length; i++){
          L.marker(stops.records[i].fields.geo_point_2d).addTo(mymap)
            .bindPopup(stops.records[i].fields.nomarretdepart).openPopup();
          myMovingMarker.addLatLng(stops.records[i].fields.geo_point_2d, [1000]);
        }
      }
      //setInterval(getCoordinate, 10*1000);
      getCoordinate();

    </script>
  </body>
</html>
